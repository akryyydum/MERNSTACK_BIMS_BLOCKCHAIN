# GitHub Actions Workflow for Security Scanning
# Runs npm audit and OWASP ZAP security tests

name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # Dependency vulnerability scanning
  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ['back', 'front', 'blockchain']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: ./${{ matrix.directory }}
        run: npm ci
      
      - name: Run npm audit
        working-directory: ./${{ matrix.directory }}
        run: |
          # Fail on high and critical vulnerabilities only
          npm audit --omit=dev --audit-level=high
        continue-on-error: false
      
      - name: Generate audit report
        if: always()
        working-directory: ./${{ matrix.directory }}
        run: |
          npm audit --json > audit-report.json || true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: audit-report-${{ matrix.directory }}
          path: ${{ matrix.directory }}/audit-report.json

  # OWASP ZAP baseline scan
  zap-scan:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install backend dependencies
        working-directory: ./back
        run: npm ci
      
      - name: Start backend server
        working-directory: ./back
        run: |
          # Start server in background
          npm start &
          echo $! > server.pid
          # Wait for server to start
          sleep 10
        env:
          NODE_ENV: test
          PORT: 4000
          MONGODB_URI: mongodb://localhost:27017/test
      
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:4000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
      
      - name: Stop backend server
        if: always()
        working-directory: ./back
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi
      
      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-baseline-report
          path: |
            report_html.html
            report_json.json

  # Static code analysis
  code-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies (backend)
        working-directory: ./back
        run: npm ci
      
      - name: Check for sensitive data
        run: |
          # Check for hardcoded secrets (basic regex)
          echo "Checking for potential secrets..."
          grep -rniE "(password|secret|api[_-]?key|token|auth)['\"]?\s*[:=]\s*['\"][\w\-]{8,}" back/ || true
          grep -rniE "mongodb://.*:.*@" back/ || true
      
      - name: Scan for TODO security items
        run: |
          echo "Checking for security TODOs..."
          grep -rni "TODO.*security" . || true
          grep -rni "FIXME.*security" . || true

  # Summary report
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, zap-scan, code-analysis]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results for details." >> $GITHUB_STEP_SUMMARY
